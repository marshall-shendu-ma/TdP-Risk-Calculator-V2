<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TdP & QT Risk Calculator</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <h1>TdP & QT Risk Assessment</h1>
      <p>A web-based tool to estimate torsades de pointes risk and QT prolongation thresholds.</p>
    </header>

    <div class="main-container">
      <section class="inputs">
        <form id="riskForm">
          <div class="field-group">
            <label for="cmax">Cmax <span id="cmaxUnit">(nM)</span></label>
            <div style="display: flex; gap: 10px;">
              <input type="number" step="any" id="cmax" value="8.1" required>
              <button type="button" onclick="toggleCmaxUnit()" style="padding: 5px 10px;">Switch to µM</button>
            </div>
          </div>

          <div class="field-group">
            <label for="arrhythmia">Arrhythmia Type</label>
            <select id="arrhythmia">
              <option value="0">No arrhythmia</option>
              <option value="1" selected>Type A arrhythmia</option>
              <option value="2">Other arrhythmia</option>
            </select>
          </div>

          <div class="field-group">
            <label for="celltype">Cell Type (numeric)</label>
            <input type="number" step="any" id="celltype" value="0" required>
          </div>

          <div class="field-group">
            <label for="assay">Assay Incubation Time</label>
            <select id="assay">
              <option value="30" selected>30 min</option>
              <option value="24">24 hours</option>
            </select>
          </div>

          <div class="field-group wide">
            <label>Concentration – FPDc Pairs</label>
            <table>
              <thead>
                <tr><th>Conc (nM)</th><th>FPDc (ms)</th><th></th></tr>
              </thead>
              <tbody id="dataBody"></tbody>
            </table>
            <button type="button" onclick="addRow()" class="small-btn">Add row</button>
          </div>

          <button type="submit" class="submit-btn">Calculate</button>
        </form>
      </section>

      <section class="outputs">
        <div class="results-section">
          <h2>Predicted QT Prolongation Based on Kilfoil Model (Kilfoil et al, 2021)</h2>
          <p><strong>Estimated QTc (log M):</strong> <span id="qtcValueLog"></span></p>
          <p id="estimatedQTc"><strong>Estimated QTc:</strong> <span id="qtcValue"></span> <button type="button" onclick="toggleQTUnit()">Switch to µM</button></p>
        </div>

        <div class="chart-block">
          <h2 id="riskChartTitle">Model 2 TdP Risk <button type="button" onclick="switchModel()">Switch TdP Risk Calculating Model</button></h2>
          <div id="modelRiskDescription">Ordinal regression</div>
          <canvas id="riskBarChart"></canvas>
        </div>

        <div class="chart-block">
          <h2>Hill Fit Curve</h2>
          <canvas id="hillPlot"></canvas>
        </div>
      </section>
    </div>
  </div>

  <script>
    let cmaxIsNM = true;
    const defaultData = [
      [0, 0], [0.3, -9.8965], [1, -6.0425], [3, -6.2026],
      [10, 0.1193], [30, 26.6547], [100, 56.3602]
    ];

    document.addEventListener("DOMContentLoaded", () => {
      const tbody = document.getElementById("dataBody");
      defaultData.forEach(pair => {
        const row = document.createElement("tr");
        row.innerHTML = \`
          <td><input type="number" step="any" value="\${pair[0]}" required></td>
          <td><input type="number" step="any" value="\${pair[1]}" required></td>
          <td><button type="button" onclick="removeRow(this)">−</button></td>
        \`;
        tbody.appendChild(row);
      });
    });

    function addRow() {
      const tbody = document.getElementById("dataBody");
      const row = document.createElement("tr");
      row.innerHTML = \`
        <td><input type="number" step="any" required></td>
        <td><input type="number" step="any" required></td>
        <td><button type="button" onclick="removeRow(this)">−</button></td>
      \`;
      tbody.appendChild(row);
    }

    function removeRow(button) {
      const row = button.closest("tr");
      if (row && row.parentNode) row.parentNode.removeChild(row);
    }

    function toggleCmaxUnit() {
      const cmaxInput = document.getElementById("cmax");
      const unitLabel = document.getElementById("cmaxUnit");
      const button = event.target;
      let value = parseFloat(cmaxInput.value);

      if (!isNaN(value)) {
        if (cmaxIsNM) {
          value = value / 1000;
          unitLabel.textContent = "(µM)";
          button.textContent = "Switch to nM";
        } else {
          value = value * 1000;
          unitLabel.textContent = "(nM)";
          button.textContent = "Switch to µM";
        }
        cmaxInput.value = value.toFixed(4);
        cmaxIsNM = !cmaxIsNM;
      }
    }
  </script>

  <script src="script.js"></script>
</body>
</html>
