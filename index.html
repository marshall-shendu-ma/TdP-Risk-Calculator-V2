<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TdP Risk Categorization Calculator Program</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script src="script_v232.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js" defer></script>
</head>
<body>
  <div class="app">
    <header style="background-color: rgb(40,124,188); color: white; padding: 20px; margin-bottom: 20px;">
      <h1 style="margin: 0;">TdP Risk Categorization Calculator Program</h1>
    </header>
    
    <section class="predictors">
      <h2>Predictor Inputs</h2>
      <div class="predictor-grid" style="display:flex; gap:20px; margin-bottom:10px;">
        <div style="display:flex; flex-direction:column;">
          <label for="predictor1"><strong>Predictor 1</strong></label>
          <p>Did drug-induced arrhythmias occur at any concentration? 0=no arrhythmia, 1=type A arrhythmia, 2=any other arrhythmia type.</p>
          <select id="predictor1">
            <option value="0">0</option><option value="1">1</option><option value="2">2</option>
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="predictor4"><strong>Predictor 4</strong></label>
          <p>Maximum repolarization change observed at any concentration (ms).</p>
          <input type="number" id="predictor4" step="any" placeholder="e.g. 25">
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="predictor7"><strong>Predictor 7</strong></label>
          <p>Drug-induced repolarization change at expected Cmax (ms).</p>
          <input type="number" id="predictor7" step="any" placeholder="e.g. 15">
        </div>
      </div>
      <button type="button" id="predictorCalcBtn">Calculate</button>
    </section>
    <section class="charts">
      <h2>Program Outputs</h2>
      <div class="model-panel">
        <div style="display:flex; align-items:center; gap:10px;">
          <h3 id="modelTitle">Model 1 TdP Risk</h3>
          <button id="toggleModelBtn">Switch Model</button>
        </div>
        <p id="modelSubtitle"></p>
        <div id="modelResults"></div>
        <canvas id="modelChart"></canvas>
    <section class="instructions">
      <h2>Instructions</h2>
      <ol>
        <li>For details on how to use the hiPSC-CM CiPA TdP Risk Categorization Tool, read the <a href="cou.html#coU" target="_blank">Context of Use (CoU)</a>, which includes <a href="cou.html#limitations" target="_blank">limitations of use</a>.</li>
        <li>Insert the model predictor input parameters in the “TdP input parameters” table. Hover over the information icons next to each section header for definitions and range of use. Check changes in the waveform parameter interactive visual.</li>
        <li>Read the outputs in the “Program Outputs” table to obtain the TdP risk categorization estimated by the selected parameters.</li>
        <li>Graphical depiction of the estimated TdP risk potential will be displayed in the “TdP Risk Categorization Estimation” section. The concentration-response curves (Hill Curve) update with the estimated Cmax for the selected pulse parameters.</li>
      </ol>
    </section>

      </div>
      <section class="inputs collapsible">
        <h2 id="cmaxSectionHeader" style="cursor:pointer;">▸ Cmax Extrapolation</h2>
        <div id="cmaxSectionContent" style="display:none;">
          <form id="riskForm">
            <div style="display:flex; align-items:center; gap:10px;">
              <label for="cmax" id="cmaxLabel">Cmax (µM)</label>
              <input type="number" id="cmax" step="any" required placeholder="e.g. 150.5">
              <button type="button" id="switchCmaxUnit">Switch Unit</button>
            </div>
            <div><label for="arrhythmia">Arrhythmia Type</label><select id="arrhythmia"><option value="0">None</option><option value="1">Type A</option><option value="2">Other</option></select></div>
            <div>
              <label>Concentration – FPDc Pairs</label>
              <table><thead><tr><th>Conc</th><th>ΔΔFPDc (ms)</th><th></th></tr></thead>
              <tbody id="dataBody">
                <tr><td><input name="concentration[]" type="number" step="any" required></td><td><input name="fpdc[]" type="number" step="any" required></td><td><button type="button" onclick="removeRow(this)">−</button></td></tr>
                <tr><td><input name="concentration[]" type="number" step="any" required></td><td><input name="fpdc[]" type="number" step="any" required></td><td><button type="button" onclick="removeRow(this)">−</button></td></tr>
                <tr><td><input name="concentration[]" type="number" step="any" required></td><td><input name="fpdc[]" type="number" step="any" required></td><td><button type="button" onclick="removeRow(this)">−</button></td></tr>
                <tr><td><input name="concentration[]" type="number" step="any" required></td><td><input name="fpdc[]" type="number" step="any" required></td><td><button type="button" onclick="removeRow(this)">−</button></td></tr>
            </tbody></table>
              <button type="button" onclick="addRow()">Add row</button>
            </div>
            <button type="submit">Calculate</button>
          </form>
          <section class="description">
            <h2>Ideal Waveform Parameter Description</h2>
            <img src="Figure1_SampleWaveform.jpg" style="height:400px; max-width:100%;" alt="Waveform">
          </section>
        </div>
      </section>
      <section class="hill-fit collapsible">
        <h2 id="hillSectionHeader" style="cursor:pointer;">▸ Hill Fit Curve (only available when input is filled in Cmax Extrapolation)</h2>
        <div id="hillSectionContent" style="display:none;">
          <div class="chart-block"><canvas id="hillPlot"></canvas></div>
        </div>
      </section>
      <section class="qt-pred collapsible">
        <h2 id="qtSectionHeader" style="cursor:pointer;">▸ QT Prolongation Prediction (in progress)</h2>
        <div id="qtSectionContent" style="display:none;">
          <div class="chart-block">
            <h3>Predicted QT Prolongation Based on Kilfoil Model (Kilfoil et al, 2021)</h3>
            <p><strong>Notes:</strong> QTc is estimated concentration for >10 ms QT prolongation.<br>cAPD<sub>90</sub> is corrected APD<sub>90</sub>.</p>
            <p><strong>Equation:</strong> QTc = 0.92 × cAPD<sub>90</sub> − 0.35</p>
            <p id="estimatedQTc">N/A</p>
          </div>
        </div>
      </section>
      <section class="references">
        <h2>References</h2>
        <ul>
          <li><a href="https://pubmed.ncbi.nlm.nih.gov/30257217/" target="_blank">Blinova et al. 2018 PMID: 30257217</a></li>
          <li><a href="https://pubmed.ncbi.nlm.nih.gov/30912807/" target="_blank">Patel et al. 2019 PMID: 30912807</a></li>
          <li><a href="https://pubmed.ncbi.nlm.nih.gov/34678241/" target="_blank">Kilfoil et al, 2021 PMID: 34678241</a></li>
        </ul>
      </section>
    </section>
  </div>
</body>
</html>