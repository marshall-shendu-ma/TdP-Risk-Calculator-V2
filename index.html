<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TdP Risk Categorization Calculator Program</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script src="script_v232.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js" defer></script>
</head>
<body>
  <div class="app">
    <header style="background-color: rgb(40,124,188); color: white; padding: 20px; margin-bottom: 20px;">
      <h1 style="margin: 0;">TdP Risk Categorization Calculator Program</h1>
    </header>
    <section class="introduction">
      <h2>Instructions</h2>
      <ol>
        <li>Read the <a href="cou.html#coU" target="_blank">Context of Use</a>.</li>
        <li>Use the “Cmax Extrapolation” section (click triangle).</li>
        <li>Or enter values in “Predictor Inputs.”</li>
        <li>View results in “Program Outputs.”</li>
      </ol>
    </section>

    <!-- Predictor Inputs -->
    <section class="predictors">
      <h2>Predictor Inputs</h2>
      <div class="predictor-grid" style="display:flex; gap:20px; margin-bottom:10px;">
        <div style="display:flex; flex-direction:column;">
          <label for="predictor1"><strong>Predictor 1</strong></label>
          <p>Did drug-induced arrhythmias occur at any concentration? 0=no arrhythmia, 1=type A arrhythmia, 2=any other arrhythmia type.</p>
          <select id="predictor1">
            <option value="0">0</option><option value="1">1</option><option value="2">2</option>
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="predictor4"><strong>Predictor 4</strong></label>
          <p>Maximum repolarization change observed at any concentration (ms).</p>
          <input type="number" id="predictor4" step="any" placeholder="e.g. 25">
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="predictor7"><strong>Predictor 7</strong></label>
          <p>Drug-induced repolarization change at expected Cmax (ms).</p>
          <input type="number" id="predictor7" step="any" placeholder="e.g. 15">
        </div>
      </div>
      <button type="button" id="predictorCalcBtn">Calculate</button>
    </section>

    <section class="charts">
      <h2>Program Outputs</h2>
      <div class="model-panel">
        <div style="display:flex; align-items:center; gap:10px;">
          <h3 id="modelTitle">Model 1 TdP Risk</h3>
          <button id="toggleModelBtn">Switch Model</button>
        </div>
        <p id="modelSubtitle"></p>
        <div id="modelResults"></div>
        <canvas id="modelChart"></canvas>
      </div>

      <!-- Cmax Extrapolation (collapsed by default) -->
      <section class="inputs collapsible">
        <h2 id="cmaxSectionHeader" style="cursor:pointer;">▸ Cmax Extrapolation</h2>
        <div id="cmaxSectionContent" style="display:none;">
          <form id="riskForm">
            <div style="display:flex; align-items:center; gap:10px;">
              <label for="cmax" id="cmaxLabel">Cmax (µM)</label>
              <input type="number" id="cmax" step="any" required placeholder="e.g. 150.5">
              <button type="button" id="switchCmaxUnit">Switch Unit</button>
            </div>
            <div>
              <label for="arrhythmia">Arrhythmia Type</label>
              <select id="arrhythmia"><option value="0">None</option><option value="1">Type A</option><option value="2">Other</option></select>
            </div>
            <div>
              <label for="celltype">Cell Type</label>
              <input type="number" id="celltype" step="any" value="0">
            </div>
            <div>
              <label for="assay">Assay Time</label>
              <select id="assay"><option value="30">30 min</option><option value="24">24 hr</option></select>
            </div>
            <div>
              <label>Concentration – FPDc Pairs</label>
              <table><thead><tr><th>Conc</th><th>ΔΔFPDc (ms)</th><th></th></tr></thead>
                <tbody id="dataBody">
                  <tr><td><input name="concentration[]" type="number" step="any" required></td><td><input name="fpdc[]" type="number" step="any" required></td><td><button type="button" onclick="removeRow(this)">−</button></td></tr>
                  <tr><td><input name="concentration[]" type="number" step="any" required></td><td><input name="fpdc[]" type="number" step="any" required></td><td><button type="button" onclick="removeRow(this)">−</button></td></tr>
                  <tr><td><input name="concentration[]" type="number" step="any" required></td><td><input name="fpdc[]" type="number" step="any" required></td><td><button type="button" onclick="removeRow(this)">−</button></td></tr>
                </tbody>
              </table>
              <button type="button" onclick="addRow()">Add row</button>
            </div>
            <button type="submit">Calculate</button>
          </form>
          <section class="description">
            <h2>Ideal Waveform Parameter Description</h2>
            <img src="Figure1_SampleWaveform.jpg" style="height:400px; max-width:100%;" alt="Waveform">
          </section>
        </div>
      </section>

      <!-- Hill Fit Curve (collapsed) -->
      <section class="hill-fit collapsible">
        <h2 id="hillSectionHeader" style="cursor:pointer;">▸ Hill Fit Curve (only available when input is filled in Cmax Extrapolation)</h2>
        <div id="hillSectionContent" style="display:none;">
          <div class="chart-block"><canvas id="hillPlot"></canvas></div>
        </div>
      </section>

      <!-- Predicted QT Prolongation -->
      <div class="chart-block">
        <h3>Predicted QT Prolongation Based on Kilfoil Model (Kilfoil et al, 2021)</h3>
        <p><strong>Notes:</strong> QTc is estimated concentration for >10 ms QT prolongation.<br>
        cAPD<sub>90</sub> is corrected APD<sub>90</sub>.</p>
        <p><strong>Equation:</strong> QTc = 0.92 × cAPD<sub>90</sub> − 0.35</p>
        <p id="estimatedQTc">N/A</p>
      </div>

    </section>
  </div>
</body>
</html>